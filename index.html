<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Online</title>
<style>
body { font-family: Arial; background:#1a1a1a; color:#fff; text-align:center; margin:0; padding:0; }
input, button { padding:10px; margin:5px; border-radius:5px; border:none; }
#chatBox { width:90%; max-width:600px; height:300px; overflow:auto; background:#333; margin:10px auto; padding:10px; text-align:left; }
.message { margin:5px 0; display:flex; align-items:center; }
.message img { margin-right:10px; border-radius:50%; width:30px; height:30px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body>

<h1>شات أونلاين</h1>

<div id="authDiv">
  <input type="email" id="email" placeholder="البريد الإلكتروني"><br>
  <input type="password" id="password" placeholder="كلمة السر"><br>
  <input type="file" id="profilePic" accept="image/*"><br>
  <button onclick="signup()">إنشاء حساب جديد</button>
  <button onclick="login()">تسجيل الدخول</button>
</div>

<div id="chatDiv" style="display:none;">
  <input type="text" id="searchUser" placeholder="بحث عن صديق"><br>
  <input type="text" id="messageInput" placeholder="اكتب رسالة">
  <button onclick="sendMessage()">إرسال</button>
  <div id="chatBox"></div>
  <button onclick="logout()">تسجيل الخروج</button>
</div>

<script>
// إعداد Firebase
const firebaseConfig = {
  apiKey: "ضع هنا API_KEY",
  authDomain: "ضع هنا AUTH_DOMAIN",
  projectId: "ضع هنا PROJECT_ID",
  storageBucket: "ضع هنا STORAGE_BUCKET",
  messagingSenderId: "ضع هنا MESSAGING_SENDER_ID",
  appId: "ضع هنا APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// تسجيل الدخول
function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email, password)
  .then(() => { showChat(); })
  .catch(e => alert(e.message));
}

// إنشاء حساب جديد مع رفع صورة البروفايل
function signup() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const file = document.getElementById("profilePic").files[0];

  auth.createUserWithEmailAndPassword(email, password)
  .then(userCredential => {
    const user = userCredential.user;
    if(file) {
      const storageRef = storage.ref(`profiles/${user.uid}`);
      storageRef.put(file).then(() => {
        storageRef.getDownloadURL().then(url => {
          db.collection("users").doc(user.uid).set({ uid:user.uid, email, profilePic: url });
          showChat();
        });
      });
    } else {
      db.collection("users").doc(user.uid).set({ uid:user.uid, email, profilePic: "https://i.pravatar.cc/150?img=3" });
      showChat();
    }
  })
  .catch(e => alert(e.message));
}

// عرض الشات بعد تسجيل الدخول
function showChat() {
  document.getElementById("authDiv").style.display = "none";
  document.getElementById("chatDiv").style.display = "block";
  loadMessages();
}

// تسجيل الخروج
function logout() {
  auth.signOut();
  document.getElementById("authDiv").style.display = "block";
  document.getElementById("chatDiv").style.display = "none";
}

// إرسال رسالة
function sendMessage() {
  const msg = document.getElementById("messageInput").value;
  if(msg.trim()==="") return;
  const user = auth.currentUser;
  db.collection("messages").add({ uid:user.uid, user:user.email, msg, timestamp: Date.now() });
  document.getElementById("messageInput").value = "";
}

// تحميل الرسائل لحظيًا مع صور البروفايل
function loadMessages() {
  db.collection("messages").orderBy("timestamp")
  .onSnapshot(async snapshot => {
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";
    for(const doc of snapshot.docs) {
      const m = doc.data();
      const userDoc = await db.collection("users").doc(m.uid).get();
      const profile = userDoc.exists ? userDoc.data().profilePic : "https://i.pravatar.cc/150?img=3";
      chatBox.innerHTML += `<div class="message"><img src="${profile}"><b>${m.user}:</b> ${m.msg}</div>`;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

// البحث عن المستخدمين بالاسم أو البريد
function searchUsers() {
  const query = document.getElementById("searchUser").value.toLowerCase();
  db.collection("users").get().then(snapshot => {
    let results = "";
    snapshot.forEach(doc => {
      const user = doc.data();
      if(user.email.toLowerCase().includes(query)) {
        results += `<div><img src="${user.profilePic}" width="30" height="30"> ${user.email}</div>`;
      }
    });
    document.getElementById("chatBox").innerHTML = results;
  });
}
document.getElementById("searchUser").addEventListener("input", searchUsers);
</script>

</body>
</html>
